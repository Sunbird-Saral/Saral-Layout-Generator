#!groovy
node('saral-poc') {

   try {
            stage('Checkout'){
               checkout scm
            }
            stage('compress build folder')
                           withCredentials([usernamePassword(credentialsId: 'anuvaad-docker-hub-credentials', passwordVariable: 'dockerhub_pass', usernameVariable: 'dockerhub_user')])
                           {
                                          sh '''
                                          if [ -f "$(pwd)/build" ]
                                          then
                                          sudo rm -rf $(pwd)/build
                                          fi
                                          if [  $( docker ps -q -f status=exited --filter "name=$JOB_BASE_NAME" ) ]
                                          then
                                          docker rm "$JOB_BASE_NAME"
                                          fi
                                          commit_id=${BUILD_ID}-$(git rev-parse --short HEAD)
                                          echo $commit_id> commit_id.txt  

                                          docker build -t $image_name:$image_tag -f Dockerfile.dev .
                                          '''
                           }
   }

   catch (err) {
      currentBuild.result = "FAILURE"
      throw err
   }
}
